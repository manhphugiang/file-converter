# Monitoring Dashboard - runs on master (8GB RPi) - always running
apiVersion: apps/v1
kind: Deployment
metadata:
  name: monitoring-dashboard
  namespace: file-converter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: monitoring-dashboard
  template:
    metadata:
      labels:
        app: monitoring-dashboard
    spec:
      nodeSelector:
        node-role.kubernetes.io/master: "true"
      tolerations:
        - key: node-role.kubernetes.io/master
          effect: NoSchedule
      containers:
        - name: monitoring-dashboard
          image: giangma/fileconverter:monitoring-dashboard-v2.5
          command: ["/bin/sh", "-c"]
          args:
            - |
              sed -i 's|app.mount("/static"|app.mount("/monitor/static", StaticFiles(directory="/app/static/static"), name="monitor_static")\n    app.mount("/static"|' /app/main.py
              sed -i 's|@app.get("/api|@app.get("/monitor/api|g' /app/main.py
              exec python main.py
          ports:
            - containerPort: 8080
          env:
            - name: PROMETHEUS_URL
              value: "http://prometheus.monitoring.svc.cluster.local:9090"
            - name: REDIS_URL
              value: "redis://redis.file-converter.svc.cluster.local:6379/0"
            - name: MINIO_ENDPOINT
              value: "minio.file-converter.svc.cluster.local:9000"
            - name: MINIO_ACCESS_KEY
              value: "minioadmin"
            - name: MINIO_SECRET_KEY
              value: "minioadmin123"
            - name: MINIO_BUCKET_NAME
              value: "file-converter"
            - name: NODE_IPS
              value: "192.168.2.1,192.168.2.2,192.168.2.3,192.168.2.4,192.168.2.5"  # worker1-4, master
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "384Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /api/health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: monitoring-dashboard
  namespace: file-converter
spec:
  selector:
    app: monitoring-dashboard
  ports:
    - port: 8080
      targetPort: 8080
