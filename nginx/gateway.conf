events {
    worker_connections 1024;
}

http {
    # Upstream service definitions
    upstream frontend {
        server frontend:3000;
    }
    
    upstream job-manager {
        server job-manager:8010;
    }
    
    upstream docx-pdf-service {
        server docx-pdf-service:8001;
    }
    
    upstream monitoring-dashboard {
        server monitoring-dashboard:8080;
    }
    
    # Rate limiting zones
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=upload:10m rate=20r/s;
    
    # Main server block - SINGLE ENTRY POINT
    server {
        listen 80;
        server_name localhost;
        
        # Security headers
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        
        # Frontend routes (React SPA)
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle SPA routing
            try_files $uri $uri/ @fallback;
        }
        
        location @fallback {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Job Management API (Central)
        location /api/upload {
            limit_req zone=upload burst=50 nodelay;
            
            proxy_pass http://job-manager/upload;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Handle large file uploads
            client_max_body_size 100M;
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            proxy_request_buffering off;
        }
        
        location /api/status {
            limit_req zone=api burst=10 nodelay;
            
            proxy_pass http://job-manager/status;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/download {
            limit_req zone=upload burst=30 nodelay;
            
            proxy_pass http://job-manager/download;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }
        
        location /api/jobs {
            limit_req zone=api burst=10 nodelay;
            
            proxy_pass http://job-manager/jobs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/session/jobs {
            limit_req zone=api burst=10 nodelay;
            
            proxy_pass http://job-manager/session/jobs;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Service-specific conversion endpoints (Direct to services)
        location /api/convert/pdf {
            limit_req zone=api burst=5 nodelay;
            
            proxy_pass http://docx-pdf-service/convert;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
        }
        
        # Health checks for all services
        location /api/health {
            limit_req zone=api burst=20 nodelay;
            
            proxy_pass http://job-manager/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Admin endpoints (restricted access)
        location /api/admin {
            # Optional: Restrict admin access by IP
            # allow 192.168.1.0/24;
            # allow 10.0.0.0/8;
            # deny all;
            
            limit_req zone=api burst=5 nodelay;
            
            proxy_pass http://job-manager/admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Monitoring Dashboard
        location /monitor/ {
            proxy_pass http://monitoring-dashboard/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /monitor/api/ {
            proxy_pass http://monitoring-dashboard/api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /monitor/static/ {
            proxy_pass http://monitoring-dashboard/static/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Service health checks (for monitoring)
        location /health/job-manager {
            proxy_pass http://job-manager/health;
            access_log off;
        }
        
        location /health/docx-pdf {
            proxy_pass http://docx-pdf-service/health;
            access_log off;
        }
    }
}